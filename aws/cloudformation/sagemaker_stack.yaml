AWSTemplateFormatVersion: '2010-09-09'
Description: >
  CloudFormation stack for Granite-8B fine-tuning on SageMaker.
  Target: Embedded Automotive Code Generation (AVB/TSN)

Parameters:
  ProjectName:
    Type: String
    Default: granite-8b-avb-tsn-finetuning
    Description: Project name for resource naming

  S3BucketName:
    Type: String
    Default: granite-8b-unified-automotive-data
    Description: S3 bucket for training data and model artifacts

  Environment:
    Type: String
    Default: development
    AllowedValues:
      - development
      - staging
      - production
    Description: Deployment environment

Resources:
  # ============================================================================
  # IAM Role for SageMaker
  # ============================================================================
  SageMakerExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-sagemaker-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - sagemaker.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSageMakerFullAccess
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - !Sub 'arn:aws:s3:::${S3BucketName}'
                  - !Sub 'arn:aws:s3:::${S3BucketName}/*'
        - PolicyName: ECRAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ecr:GetAuthorizationToken
                  - ecr:BatchCheckLayerAvailability
                  - ecr:GetDownloadUrlForLayer
                  - ecr:BatchGetImage
                Resource: '*'
        - PolicyName: CloudWatchAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:DescribeLogStreams
                Resource:
                  - !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/sagemaker/*'
        - PolicyName: BedrockAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - bedrock:InvokeModel
                  - bedrock:InvokeModelWithResponseStream
                Resource:
                  - !Sub 'arn:aws:bedrock:${AWS::Region}::foundation-model/*'
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # ============================================================================
  # CloudWatch Log Group
  # ============================================================================
  SageMakerLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/sagemaker/${ProjectName}'
      RetentionInDays: 30
      Tags:
        - Key: Project
          Value: !Ref ProjectName

  # ============================================================================
  # SNS Topic for Alerts
  # ============================================================================
  AlertTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub '${ProjectName}-alerts'
      DisplayName: !Sub '${ProjectName} Training Alerts'
      Tags:
        - Key: Project
          Value: !Ref ProjectName

  # ============================================================================
  # CloudWatch Alarm for Training Failures
  # ============================================================================
  TrainingFailureAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${ProjectName}-training-failure'
      AlarmDescription: Alert when training job fails
      Namespace: AWS/SageMaker
      MetricName: TrainingJobStatus
      Dimensions:
        - Name: TrainingJobName
          Value: !Sub '${ProjectName}-*'
      Statistic: Maximum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: LessThanThreshold
      AlarmActions:
        - !Ref AlertTopic
      TreatMissingData: notBreaching

  # ============================================================================
  # ECR Repository for Training Container
  # ============================================================================
  ECRRepository:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Sub '${ProjectName}'
      ImageScanningConfiguration:
        ScanOnPush: true
      LifecyclePolicy:
        LifecyclePolicyText: |
          {
            "rules": [
              {
                "rulePriority": 1,
                "description": "Keep last 10 images",
                "selection": {
                  "tagStatus": "any",
                  "countType": "imageCountMoreThan",
                  "countNumber": 10
                },
                "action": {
                  "type": "expire"
                }
              }
            ]
          }
      Tags:
        - Key: Project
          Value: !Ref ProjectName

# ============================================================================
# Outputs
# ============================================================================
Outputs:
  SageMakerRoleArn:
    Description: ARN of the SageMaker execution role
    Value: !GetAtt SageMakerExecutionRole.Arn
    Export:
      Name: !Sub '${ProjectName}-SageMakerRoleArn'

  LogGroupName:
    Description: CloudWatch log group name
    Value: !Ref SageMakerLogGroup
    Export:
      Name: !Sub '${ProjectName}-LogGroupName'

  AlertTopicArn:
    Description: SNS topic ARN for alerts
    Value: !Ref AlertTopic
    Export:
      Name: !Sub '${ProjectName}-AlertTopicArn'

  ECRRepositoryUri:
    Description: ECR repository URI
    Value: !Sub '${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${ECRRepository}'
    Export:
      Name: !Sub '${ProjectName}-ECRRepositoryUri'

  S3BucketName:
    Description: S3 bucket for training data
    Value: !Ref S3BucketName
    Export:
      Name: !Sub '${ProjectName}-S3BucketName'
